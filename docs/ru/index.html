<!DOCTYPE html>
<!--
Backdoc is a tool for backbone-like documentation generation. 
Backdoc main goal is to help to generate one page documentation from one markdown source file.

https://github.com/chibisov/backdoc
-->
<html>
<head>
    <meta charset="UTF-8"/>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="HandheldFriendly" content="true" />
    <title>Документация &laquo; phpDaemon</title>

    <link rel="stylesheet" href="../normalize.min.css" />
    <link rel="stylesheet" href="../styles.doc.css" />
    <script src="../zepto.js"></script>

    <script type="text/javascript">
        $(function(){
            $('.toggle_sidebar_button').on('click', function(){
                $('body').toggleClass('force_show_sidebar');
            });

            // hide sidebar on every click in menu (if small screen)
            $('.sidebar').find('a').on('click', function(){
                $('body').removeClass('force_show_sidebar');
            });

            // add anchors
            $.each($('.main_container').find('h1,h2,h3,h4,h5,h6'), function(key, item){
                if ($(item).attr('id')) {
                    $(item).addClass('anchor');
                    $(item).append($('<span class="anchor_char">¶</span>'))
                    $(item).on('click', function(){
                        window.location = '#' + $(item).attr('id');
                    })
                }
            });

            // remove <code> tag inside of <pre>
            $.each($('pre > code'), function(key, item){
                $(item).parent().html($(item).html())
            })
        })
    </script>
</head>
<body>
    <a class="toggle_sidebar_button">
        <div class="line"></div>
        <div class="line"></div>
        <div class="line"></div>
    </a>
    <div class="sidebar">
        <ul>
  <li><a href="#phpdaemon">PHPDaemon</a></li>
  <li><a href="#osnovyi">Основы</a></li>
  <li><a href="#ustanovka">Установка</a>
  <ul>
    <li><a href="#trebovaniya">Требования</a></li>
    <li><a href="#ishodnyij-kod">Исходный код</a></li>
    <li><a href="#composer">Composer</a></li>
    <li><a href="#centos-redhat">CentOS/RedHat</a></li>
    <li><a href="#ubuntu">Ubuntu</a></li>
    <li><a href="#gentoo">Gentoo</a></li>
  </ul></li>
  <li><a href="#upravlenie">Управление</a></li>
  <li><a href="#primeryi">Примеры</a></li>
  <li><a href="#marshrutizatsiya">Маршрутизация</a></li>
  <li><a href="#konfiguratsiya">Конфигурация</a>
  <ul>
    <li><a href="#tipyi-dannyih">Типы данных</a>
    <ul>
      <li><a href="#size">Size</a></li>
      <li><a href="#time">Time</a></li>
      <li><a href="#number">Number</a></li>
    </ul></li>
    <li><a href="#globalnyie-optsii">Глобальные опции</a>
    <ul>
      <li><a href="#plavnyij-perezapusk-rabochih-protsessov">Плавный перезапуск рабочих процессов</a></li>
      <li><a href="#osnovnyie-puti">Основные пути</a></li>
      <li><a href="#svyazannyie-s-master-protsessom">Связанные с мастер-процессом</a></li>
      <li><a href="#zaprosyi">Запросы</a></li>
      <li><a href="#rabochie-protsessyi">Рабочие процессы</a></li>
      <li><a href="#logirovanie-i-otladka">Логирование и отладка</a></li>
      <li><a href="#podsistema-vvoda-vyivoda-posix">Подсистема ввода-вывода POSIX</a></li>
    </ul></li>
    <li><a href="#prilozheniya">Приложения</a></li>
  </ul></li>
  <li><a href="#razrabotka">Разработка</a>
  <ul>
    <li><a href="#prilozhenie">Приложение</a></li>
    <li><a href="#obrabotka-zaprosov">Обработка запросов</a></li>
    <li><a href="#klientyi-i-serveryi">Клиенты и серверы</a></li>
  </ul></li>
  <li><a href="#serveryi">Серверы</a>
  <ul>
    <li><a href="#http">HTTP</a></li>
    <li><a href="#fastcgi">FastCGI</a></li>
    <li><a href="#debugconsole">DebugConsole</a></li>
    <li><a href="#flashpolicy">FlashPolicy</a></li>
    <li><a href="#ident">Ident</a></li>
    <li><a href="#ircbouncer">IRCBouncer</a></li>
    <li><a href="#lock">Lock</a></li>
    <li><a href="#socks">Socks</a></li>
    <li><a href="#websocket">WebSocket</a></li>
  </ul></li>
  <li><a href="#klientyi">Клиенты</a>
  <ul>
    <li><a href="#asterisk">Asterisk</a></li>
    <li><a href="#dns">DNS</a></li>
    <li><a href="#gibson">Gibson</a></li>
    <li><a href="#http-2">HTTP</a></li>
    <li><a href="#icmp">ICMP</a></li>
    <li><a href="#irc">IRC</a></li>
    <li><a href="#lock-2">Lock</a></li>
    <li><a href="#memcache">Memcache</a></li>
    <li><a href="#mongo">Mongo</a></li>
    <li><a href="#mysql">MySQL</a></li>
    <li><a href="#postgresql">PostgreSQL</a></li>
    <li><a href="#redis">Redis</a></li>
    <li><a href="#valve">Valve</a></li>
    <li><a href="#websocket-2">WebSocket</a></li>
    <li><a href="#xmpp">XMPP</a></li>
  </ul></li>
  <li><a href="#biblioteki">Библиотеки</a>
  <ul>
    <li><a href="#cache">Cache</a></li>
    <li><a href="#complexjob">ComplexJob</a></li>
    <li><a href="#shellcommand">ShellCommand</a></li>
    <li><a href="#timer">Timer</a></li>
    <li><a href="#transportcontext">TransportContext</a></li>
    <li><a href="#dnode">DNode</a></li>
    <li><a href="#fs">FS</a></li>
    <li><a href="#pubsub">PubSub</a></li>
  </ul></li>
  <li><a href="#utilityi">Утилиты</a>
  <ul>
    <li><a href="#binary">Binary</a></li>
    <li><a href="#crypt">Crypt</a></li>
    <li><a href="#datetime">DateTime</a></li>
    <li><a href="#encoding">Encoding</a></li>
    <li><a href="#irc-2">IRC</a></li>
    <li><a href="#mime">MIME</a></li>
    <li><a href="#shmentity">ShmEntity</a></li>
    <li><a href="#terminal">Terminal</a></li>
  </ul></li>
  <li><a href="#strukturyi">Структуры</a>
  <ul>
    <li><a href="#objectstorage">ObjectStorage</a></li>
    <li><a href="#priorityqueuecallbacks">PriorityQueueCallbacks</a></li>
    <li><a href="#stackcallbacks">StackCallbacks</a></li>
  </ul></li>
  <li><a href="#traits">Traits</a>
  <ul>
    <li><a href="#classwatchdog">ClassWatchdog</a></li>
    <li><a href="#deferredeventhandlers">DeferredEventHandlers</a></li>
    <li><a href="#eventhandlers">EventHandlers</a></li>
    <li><a href="#sessions">Sessions</a></li>
    <li><a href="#staticobjectwatchdog">StaticObjectWatchdog</a></li>
    <li><a href="#strictstaticobjectwatchdog">StrictStaticObjectWatchdog</a></li>
  </ul></li>
  <li><a href="#network">Network</a>
  <ul>
    <li><a href="#client">Client</a></li>
    <li><a href="#clientconnection">ClientConnection</a></li>
    <li><a href="#connection">Connection</a></li>
    <li><a href="#iostream">IOStream</a></li>
    <li><a href="#pool">Pool</a></li>
    <li><a href="#server">Server</a></li>
  </ul></li>
  <li><a href="#faq">FAQ</a></li>
  <li><a href="#publikatsii">Публикации</a></li>
  <li><a href="#fyuchersyi">Фьючерсы</a></li>
  <li><a href="#razrabotchiki">Разработчики</a></li>
</ul>

    </div>
    <div class="main_container">
        <h2 id="phpdaemon">PHPDaemon</h2>

<p>Это асинхронный модульный демон-фреймворк, который берёт на&#160;себя обработку I/O (libevent) и&#160;другие низкоуровневые задачи, присущие сетевым демонам.
С&#160;его помощью легко писать правильные и&#160;очень быстрые сетевые приложения.
Из&#160;коробки идут сервера FastCGI, HTTP, CGI, FlashPolicy, Telnet, WebSocket, клиенты mysql, memcached, mongodb и&#160;многое другое.
Работать с&#160;сетью действительно просто. Программист средней руки может написать, к&#160;примеру, IRC-бота за&#160;считанные часы.</p>

<p>Официальный сайт <a href="http://daemon.io/">daemon.io</a>. <br />
GitHub репозиторий <a href="https://github.com/kakserpom/phpdaemon/">github.com/kakserpom/phpdaemon</a>. <br />
Обсудить проект можно&#160;в <a href="http://groups.google.com/group/phpdaemon">Google Groups</a>. <br />
<a href="https://github.com/kakserpom/phpdaemon/issues">Багтрекер</a>.</p>

<h2 id="osnovyi">Основы</h2>

<p>PHPDaemon представляет из&#160;себя один мастер-процесс с&#160;несколькими рабочими процессами.</p>

<p>Приложение, в&#160;зависимости от&#160;нагрузки, инициализируется в&#160;одном или нескольких рабочих процессах.
Во&#160;втором случае запрос будет передан одному свободному рабочему процессу.</p>

<p>Механизма взаимодействия между ребочими процессами не&#160;предусмотрено, поэтому для синхронизации приложений в&#160;разных процессах вы&#160;можете использовать стороннее&#160;ПО, например Redis.
Также есть возможность задать опцию приложения <code>limit-instances N;</code>, чтобы ограничить кол-во копий приложения во&#160;всех рабочих процессах.</p>

<p>Исполняющий файл находится в дирктории <code>./bin/phpd</code>.
Вы можете создать свой исполняющий файл, как показано в примере <code>./bin/sampleapp</code>.
Перед запуском демон проверяет переменную <code>$configFile</code>, используя её для загрузки конфигурации.</p>

<h2 id="ustanovka">Установка</h2>

<h3 id="trebovaniya">Требования</h3>

<ul>
<li><code>PHP</code> версии не ниже 5.4;</li>
<li>Модули <code>posix</code>, <code>pcntl</code>, <code>socket</code>, <code>shmop</code>;</li>
<li><code>libevent 2</code>;</li>
<li><code>pecl-event</code> версии не ниже 1.6.1;</li>
</ul>

<p>Рекомендуется также установить:</p>

<ul>
<li><code>pecl-eio</code> для увеличения проиводительности файловой системы;</li>
<li><code>pecl-proctitle</code> для именования процессов в&#160;понятные названия: &#171;phpd: worker process&#187; (для PHP версии ниже 5.5);</li>
<li><code>pecl-inotify</code> для мониторинга файловой системы.</li>
</ul>

<h3 id="ishodnyij-kod">Исходный код</h3>

<p>Вы можете клонировать PHPDaemon репозиторий <br />
$&nbsp;<code>git clone https://github.com/kakserpom/phpdaemon.git</code></p>

<p>Или скачать текущую версию в виде архива <br />
$&nbsp;<code>wget https://github.com/kakserpom/phpdaemon/archive/master.zip</code></p>

<p>Установите необходимые модули <br />
$&nbsp;<code>pecl install event eio proctitle inotify</code></p>

<h3 id="composer">Composer</h3>

<p>Добавьте раздел в ваш composer.json</p>

<pre><code>"require" : {
    "kakserpom/phpdaemon" : "dev-master"
}
</code></pre>

<p>Подробная информации о пакете на <a href="https://packagist.org/packages/kakserpom/phpdaemon">packagist.org</a>.</p>

<h3 id="centos-redhat">CentOS/RedHat</h3>

<p>Для начала необходимо установить все сопутстсующие утилиты. <br />
$&nbsp;<code>sudo yum install -y git gcc openssl-devel libevent</code></p>

<p>Чтобы установить PHP 5.5 необходимо добавить Remi и Epel репозитории, потому что стандартный содержит старую версию.</p>

<p>Для RHEL/CentOS 6.4-6.0 32 Bit. <br />
$&nbsp;<code>sudo rpm -Uvh http://download.fedoraproject.org/pub/epel/6/i386/epel-release-6-8.noarch.rpm</code> <br />
$&nbsp;<code>sudo rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</code></p>

<p>Для RHEL/CentOS 6.4-6.0 64 Bit. <br />
$&nbsp;<code>sudo rpm -Uvh http://download.fedoraproject.org/pub/epel/6/x86_64/epel-release-6-8.noarch.rpm</code> <br />
$&nbsp;<code>sudo rpm -Uvh http://rpms.famillecollet.com/enterprise/remi-release-6.rpm</code></p>

<p>Устанавливаем PHP. <br />
$&nbsp;<code>sudo yum --enablerepo=remi,remi-test install -y php-cli php-devel php-pear php-process</code></p>

<p>Далее устанавливаем pecl модули. <br />
$&nbsp;<code>pecl install event eio</code></p>

<p>В PHP отсутсвует контроль подгрузки модулей. Для корректной работы модуля event и eio необходим модуль sockets.
В системах RedHat/CentOS модули подгружаются в порядке названия, поэтому назовем конфиги этих модулей как z-event.ini и z-eio.ini соответсвенно. <br />
$&nbsp;<code>echo "extension=event.so" &gt; /etc/php.d/z-event.ini</code>
$&nbsp;<code>echo "extension=eio.so" &gt; /etc/php.d/z-eio.ini</code></p>

<p>Установите <code>date.timezone</code> в /etc/php.ini в соответствие с временной зоной сервера.
Раскомментируйте и отредактируйте строку <code>;date.timezone =</code> (например, <code>date.timezone = Europe/Moscow</code>) <br />
$&nbsp;<code>sudo vi /etc/php.ini</code></p>

<p>Подготовим директорию для установки PHPDaemon. <br />
$&nbsp;<code>sudo mkdir /opt/phpdaemon</code> <br />
$&nbsp;<code>sudo chown [your user]:[your group] /opt/phpdaemon</code> <br />
$&nbsp;<code>cd /opt/phpdaemon</code></p>

<p>Устанавливаем PHPDaemon. <br />
$&nbsp;<code>cd /opt/phpdaemon</code> <br />
$&nbsp;<code>git clone https://github.com/kakserpom/phpdaemon.git ./</code></p>

<p>Создаем конфигурационный файл из примера. <br />
$&nbsp;<code>cp /opt/phpdaemon/conf/phpd.conf.example /opt/phpdaemon/conf/phpd.conf</code></p>

<p>Сделаем ссылку на phpd для удобного управления демоном <br />
$&nbsp;<code>ln -s /opt/phpdaemon/bin/phpd /usr/bin/phpd</code></p>

<p>Пробуем запустить демон. <br />
$&nbsp;<code>sudo phpd start --verbose-tty=1</code></p>

<p>Опция <code>--verbose-tty=1</code> указывет демону выводить лог в терминал.</p>

<p>Если вы видите что-то похожее на это:</p>

<pre><code>[PHPD] Loaded config file: '/opt/phpdaemon/conf/phpd.conf'
[PHPD] Loaded config file: 'conf/conf.d/ExampleJabberBot.conf'
[PHPD] Loaded config file: 'conf/conf.d/FastCGI.conf'
[PHPD] Loaded config file: 'conf/conf.d/FlashpolicyServer.conf'
[PHPD] Loaded config file: 'conf/conf.d/HTTPServer.conf'
[PHPD] Loaded config file: 'conf/conf.d/IdentServer.conf'
[PHPD] Loaded config file: 'conf/conf.d/SSL-sample.conf'
[PHPD] Loaded config file: 'conf/conf.d/WebSocketServer.conf'
[PHPD] [START] phpDaemon with pid-file '/var/run/phpd.pid' is running already (PID 28308)
</code></pre>

<p>Поздравляем! PHPDaemon запущен!</p>

<h3 id="ubuntu">Ubuntu</h3>

<p>Для начала необходимо установить все сопутстсующие утилиты. <br />
$&nbsp;<code>sudo apt-get install gcc make libcurl4-openssl-dev libevent-dev git libevent</code></p>

<p>Устанавливаем PHP 5.5. <br />
$&nbsp;<code>sudo apt-get install php5-cli php5-dev php-pear</code></p>

<p>Далее устанавливаем pecl модули. <br />
$&nbsp;<code>pecl install event eio</code> <br />
$&nbsp;<code>echo "extension=event.so" &gt; /etc/php5/mods-available/event.ini</code> <br />
$&nbsp;<code>echo "extension=eio.so" &gt; /etc/php5/mods-available/eio.ini</code></p>

<p>Создаем ссылки
$&nbsp;<code>ln -s /etc/php5/mods-available/event.ini /etc/php5/cli/conf.d/event.ini</code> <br />
$&nbsp;<code>ln -s /etc/php5/mods-available/eio.ini /etc/php5/cli/conf.d/eio.ini</code></p>

<p>Подготовим директорию для установки PHPDaemon. <br />
$&nbsp;<code>sudo mkdir /opt/phpdaemon</code>
$&nbsp;<code>sudo chown [your user]:[your group] /opt/phpdaemon</code> <br />
$&nbsp;<code>cd /opt/phpdaemon</code></p>

<p>Устанавливаем PHPDaemon. <br />
$&nbsp;<code>cd /opt/phpdaemon</code> <br />
$&nbsp;<code>git clone https://github.com/kakserpom/phpdaemon.git ./</code></p>

<p>Создаем конфигурационный файл из примера. <br />
$&nbsp;<code>cp /opt/phpdaemon/conf/phpd.conf.example /opt/phpdaemon/conf/phpd.conf</code></p>

<p>Сделаем ссылку на phpd для удобного управления демоном <br />
$&nbsp;<code>alias phpd='/opt/phpdaemon/bin/phpd'</code></p>

<p>Локальный алиас для sudo <br />
$&nbsp;<code>alias sudo='sudo '</code></p>

<p>Пробуем запустить демон. <br />
$&nbsp;<code>sudo phpd start --verbose-tty=1</code></p>

<p>Опция <code>--verbose-tty=1</code> указывет демону выводить лог в терминал.</p>

<p>Если вы видите что-то похожее на это:</p>

<pre><code>[PHPD] Loaded config file: '/opt/phpdaemon/conf/phpd.conf'
[PHPD] Loaded config file: 'conf/conf.d/ExampleJabberBot.conf'
[PHPD] Loaded config file: 'conf/conf.d/FastCGI.conf'
[PHPD] Loaded config file: 'conf/conf.d/FlashpolicyServer.conf'
[PHPD] Loaded config file: 'conf/conf.d/HTTPServer.conf'
[PHPD] Loaded config file: 'conf/conf.d/IdentServer.conf'
[PHPD] Loaded config file: 'conf/conf.d/SSL-sample.conf'
[PHPD] Loaded config file: 'conf/conf.d/WebSocketServer.conf'
[PHPD] [START] phpDaemon with pid-file '/var/run/phpd.pid' is running already (PID 28308)
</code></pre>

<p>Поздравляем! PHPDaemon запущен!</p>

<p>Добавим алиасы чтобы они были доступны после перезагрузки
$&nbsp;<code>echo "alias phpd='/opt/phpdaemon/bin/phpd'" &gt;&gt; ~/.bashrc'</code>
$&nbsp;<code>echo "alias sudo='sudo /opt/phpdaemon/bin/phpd'" &gt;&gt; ~/.bashrc'</code></p>

<h3 id="gentoo">Gentoo</h3>

<p>Вы можете установить PHPDaemon с помощью <a href="https://github.com/lexa-uw/layman-phpdaemon">layman overlay</a>.</p>

<p>Добавьте ссылку в секцию overlays в файле layman.cfg: <br />
<code>https://github.com/lexa-uw/layman-phpdaemon/blob/master/layman.xml</code></p>

<p>В итоге будет выглядеть примерно так:</p>

<pre><code>overlays  : http://www.gentoo.org/proj/en/overlays/repositories.xml
            https://github.com/lexa-uw/layman-phpdaemon/blob/master/layman.xml
</code></pre>

<p>Выполняем команды <br />
$&nbsp;<code>sudo layman -L</code> <br />
$&nbsp;<code>sudo layman -a phpdaemon</code> <br />
$&nbsp;<code>sudo emerge www-servers/phpdaemon</code></p>

<p>For example, below command install phpdaemon by version 0.4.1, 1.0_beta2 and weekly release.</p>

<pre><code>$ sudo emerge "=www-servers/phpdaemon-0.4.1" "=www-servers/phpdaemon-1.0_beta2" "www-servers/phpdaemon"
These are the packages that would be merged, in order:

Calculating dependencies... done!
[ebuild   R   ~] www-servers/phpdaemon-0.4.1:0.4::phpdaemon  USE="libevent -examples -runkit" 0 kB
[ebuild   R   ~] www-servers/phpdaemon-1.0_beta2:1.0::phpdaemon  USE="eio event -runkit" 0 kB
[ebuild   R   ~] www-servers/phpdaemon-20130907:weekly::phpdaemon  USE="eio event -runkit" 0 kB
...
</code></pre>

<p>After installation you can use "eselect phpdaemon set" tool for set up symlink for /usr/bin/phpd</p>

<pre><code>$ sudo eselect phpdaemon list
Available phpdaemon targets:
  [1]   phpd0.4
  [2]   phpd1.0
  [3]   phpdweekly
$ sudo eselect phpdaemon set 3
$ sudo eselect phpdaemon show
Current phpdaemon:
  weekly
</code></pre>

<p>Add phpdaemon to autoload:</p>

<pre><code>$ rc-update add phpd default
 * service phpd added to runlevel default
</code></pre>

<p>Add sepatare init.d scripts for different versions:</p>

<pre><code>$ ln -s /etc/init.d/phpd /etc/init.d/phpd-0.4
$ ln -s /etc/init.d/phpd /etc/init.d/phpd-1.0
$ ln -s /etc/init.d/phpd /etc/init.d/phpd-weekly
</code></pre>

<p>And add phpd-1.0 to autoload:</p>

<pre><code>$ rc-update add phpd-1.0 default
 * service phpd added to runlevel default
</code></pre>

<h2 id="upravlenie">Управление</h2>

<table class="invis">
  <tr>
    <td class="nowrap">$ <code>phpd start</code></td>
    <td>Запуск демона</td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd stop</code></td>
    <td>Остановка демона<br><code>SYSCTL: SIGTERM, SIGQUIT</code></td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd hardstop</code></td>
    <td>Принудительная остановка демона<br><code>SYSCTL: SIGINT, SIGKILL</code></td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd update</code></td>
    <td>Обновление конфигурации<br><code>SYSCTL: SIGHUP</code></td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd reload</code></td>
    <td>Плавный перезапуск всех рабочих процессов<br><code>SYSCTL: SIGUSR2</code></td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd reopenlog</code></td>
    <td>Переоткрытие лог-файлов<br><code>SYSCTL: SIGUSR1</code></td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd restart</code></td>
    <td>Плавный перезапуск демона</td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd hardrestart</code></td>
    <td>Принудительный перезапуск демона</td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd status</code></td>
    <td>Вывод статуса демона</td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd fullstatus</code></td>
    <td>Вывод подробной информации работы демона</td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd configtest</code></td>
    <td>Вывод глобальных опций. В скобках будет указано значение по-умочанию.</td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd log [-n K]</code></td>
    <td>Вывод лог-файла в реальном времени с помощью команды <code>tail -f</code>. C параметром <code>-n K</code> выводится K последних строк. Или используйте <code>-n +K</code> для вывода строк, начиная с K.</td>
  </tr>
  <tr>
    <td class="nowrap">$ <code>phpd runworker</code></td>
    <td>Запуск рабочего процесса без мастер-процесса. Используется для отладки.</td>
  </tr>
</table>

<h2 id="primeryi">Примеры</h2>

<p>Примеры</p>

<h2 id="marshrutizatsiya">Маршрутизация</h2>

<p>Получая запросы демон первым делом должен определить какому приложению он&#160;должен передать обработку.
Для этого служит метод <code>getRequestRoute</code> в&#160;классе <code>AppResolver</code> [<a href="https://github.com/kakserpom/phpdaemon/blob/master/PHPDaemon/Core/AppResolver.php#L159">GitHub</a>].</p>

<p>Вы&#160;можете определить свой обработчик, пример которого лежит в <code>./conf/AppResolver.php</code> [<a href="https://github.com/kakserpom/phpdaemon/blob/master/conf/AppResolver.php">GitHub</a>].</p>

<p>Метод <code>getRequestRoute</code> принимает два параметра:</p>

<ul>
<li><code>$req</code> &#8212; объект <code>stdClass</code>, с&#160;параметрами запроса;</li>
<li><code>$upstream</code> &#8212; объект сервера, принимающий входящие запросы, например <code>PHPDaemon\Servers\HTTP\Connection</code>.</li>
</ul>

<p>Результатом работы может быть:</p>

<ul>
<li>Имя приложения;</li>
<li><code>null</code> для попытки передать запрос приложению по-умолчанию;</li>
<li><code>false</code> для завершения обработки запроса.</li>
</ul>

<p>Не&#160;забудьте указать&#160;в <a href="#osnovnyie-puti">конфиге</a> путь до&#160;вашего AppResolver, например <code>path './conf/AppResolver.php';</code>.</p>

<p>В&#160;настройках <a href="#serveryi">сервера</a>, принимающего запросы, с&#160;помощью опции <code>responder</code> можно указать имя приложения по-умолчанию, которому будет передан запрос, если <code>getRequestRoute</code> вернул <code>null</code>.</p>

<h2 id="konfiguratsiya">Конфигурация</h2>

<h3 id="tipyi-dannyih">Типы данных</h3>

<p>Большинство опций phpdaemon описывается своими типами данных, позволяющие указывать значения расширенным форматом.</p>

<h4 id="size">Size</h4>

<p>Предназначен для записи объема информации. Можно записать в виде целого числа или целого числа с постфиксом.</p>

<p>Формат записи: <code>int [bBkKmMgG]?</code></p>

<table>
<tbody>
<tr><td><strong>Постфикс</strong></td><td><strong>Множитель</strong></td><td><strong>Пример</strong></td><td><strong>Значение</strong></td></tr>
<tr><td>b, B</td><td>1</td><td>1b</td><td>1</td></tr>
<tr><td>k</td><td>1000</td><td>1k</td><td>1000</td></tr>
<tr><td>K</td><td>1024</td><td>1K</td><td>1024</td></tr>
<tr><td>m</td><td>1000 * 1000</td><td>1m</td><td>1000000</td></tr>
<tr><td>M</td><td>1024 * 1024</td><td>1M</td><td>1048576</td></tr>
<tr><td>g</td><td>1000 * 1000 * 1000</td><td>1g</td><td>1000000000</td></tr>
<tr><td>G</td><td>1024 * 1024 * 1024</td><td>1G</td><td>1073741824</td></tr>
</tbody>
</table>

<!--
Примеры:

|| **Пример** || **Значение** ||
|| 1 || 1 ||
|| 1b || 1 ||
|| 1m || 1000000 ||
|| 1M || 1048576 ||
-->

<h4 id="time">Time</h4>

<p>Предназначен для записи количества секунд. Число может быть с плавающей точкой с использованием только символа <code>"."</code>.</p>

<p>Формат записи: <code>float [smhd]?</code> или <code>(float [smhd])+</code></p>

<table>
<tbody>
<tr><td><strong>Постфикс</strong></td><td><strong>Множитель</strong></td><td><strong>Пример</strong></td><td><strong>Значение</strong></td></tr>
<tr><td>s</td><td>1</td><td>1s</td><td>1</td></tr>
<tr><td>m</td><td>60</td><td>1m</td><td>60</td></tr>
<tr><td>h</td><td>60 * 60</td><td>2h 12s</td><td>7212</td></tr>
<tr><td>d</td><td>60 * 60 * 24</td><td>1d 15m 32s</td><td>87332</td></tr>
</tbody>
</table>

<!--
Примеры:

|| **Пример** || **Значение** ||
|| 1 || 1 ||
|| 1s || 1 ||
|| 1d || 86400 ||
|| 1d 15m 32s || 87332 ||
-->

<h4 id="number">Number</h4>

<p>Предназначен для записи чисел.</p>

<p>Формат записи: <code>int [kKmMgG]?</code></p>

<table>
<tbody>
<tr><td><strong>Постфикс</strong></td><td><strong>Множитель</strong></td><td><strong>Пример</strong></td><td><strong>Значение</strong></td></tr>
<tr><td>k, K</td><td>1000</td><td>1k</td><td>1000</td></tr>
<tr><td>m, M</td><td>1000 * 1000</td><td>1M</td><td>1000000</td></tr>
<tr><td>g, G</td><td>1000 * 1000 * 1000</td><td>1g</td><td>1000000000</td></tr>
</tbody>
</table>

<!--
Примеры:

|| **Пример** || **Значение** ||
|| 1 || 1 ||
|| 1K || 1000 ||
-->

<h3 id="globalnyie-optsii">Глобальные опции</h3>

<p>Два способа установки опций:</p>

<ol>
<li>Конфигурационный файл <code>./conf/phpd.conf</code>;</li>
<li>Параметры командной строки, например <code>--max-workers=1</code>.</li>
</ol>

<blockquote>
  <p>Параметры командной строки имеют больший приоритет.</p>
</blockquote>

<hr />

<h4 id="plavnyij-perezapusk-rabochih-protsessov">Плавный перезапуск рабочих процессов</h4>

<ul>
<li><p><code>max-requests (Number = '10k')</code></p>

<p>Максимальное количество запросов перед перезапуском рабочего процесса.
<code>0</code> – неограничено.</p></li>
<li><p><code>max-memory-usage (Size = '0b')</code></p>

<p>Максимальный допустимый порог потребления памяти рабочим процессом.
<code>0</code> – неограничено.</p></li>
<li><p><code>max-idle (Time = '0s')</code></p>

<p>Максимальное время простоя рабочего процесса перед перезапуском.
<code>0</code> – неограничено.</p></li>
<li><p><code>auto-reload (Time = '0s')</code></p>

<p>Задает интервал проверки всех подключенных файлов. При изменении файлов плавно перезагружает рабочие процессы.</p></li>
<li><p><code>auto-reimport (boolean = false)</code></p>

<p>На лету импортирует методы и функции из измененных файлов с помощью runkit, без перезагрузки рабочего процесса.</p></li>
</ul>

<h4 id="osnovnyie-puti">Основные пути</h4>

<ul>
<li><p><code>pid-file (string = '/var/run/phpd.pid')</code></p>

<p>Путь к pid-файлу. Убедитесь что имеется доступ на запись.</p></li>
<li><p><code>config-file (string = '/etc/phpdaemon/phpd.conf;/etc/phpd/phpd.conf;./conf/phpd.conf')</code></p>

<p>Путь к файлу конфигурации. Можно указать несколько через разделитель <code>";"</code>. <br />
Будет загружен только первый найденный конфигурационный файл.</p></li>
<li><p><code>path (string = '/etc/phpdaemon/AppResolver.php;./conf/AppResolver.php')</code></p>

<p>Путь к Application Resolver. Можно указать несколько через разделитель <code>";"</code>. <br />
Будет загружен только первый найденный файл.</p></li>
<li><p><code>add-include-path (string = null)</code></p>

<p>Дополнительные пути для директивы <a href="http://www.php.net/manual/ru/ini.core.php#ini.include-path">include_path</a>. <br />
Можно указать несколько через разделитель <code>":"</code>.</p></li>
</ul>

<h4 id="svyazannyie-s-master-protsessom">Связанные с мастер-процессом</h4>

<ul>
<li><p><code>mpm-delay (Time = '0.1s')</code></p>

<p>Интервал между срабатываниями Мульти-Процессного Менеджера. <br />
МПМ отвечает за запуск/выключение рабочих процессов, согласно настройкам.</p></li>
<li><p><code>start-workers (Number = 4)</code></p>

<p>Кол-во рабочих процессов при запуске демона.</p></li>
<li><p><code>min-workers (Number = 4)</code></p>

<p>Минимальное допустимое кол-во рабочих процессов.</p></li>
<li><p><code>max-workers (Number = 8)</code></p>

<p>Максимальное допустимое кол-во рабочих процессов.</p></li>
<li><p><code>min-spare-workers (Number = 2)</code></p>

<p>Минимальное количество простаивающих рабочих процессов: phpDaemon запустит дополнительный рабочие процессы когда нагрузка увеличится, чтобы простаивающих рабочих процессов было достаточно. Сверху ограничивается параметром max-workers.</p></li>
<li><p><code>max-spare-workers (Number = 0)</code></p>

<p>Максимальное кол-во простаивающих рабочих процессов. phpDaemon выключит дополнительные рабочие процессы когда нагрузка спадёт.</p></li>
<li><p><code>master-priorty (Number = 100)</code></p>

<p>Приоритет мастер-процесса. Чем меньше значение, тем выше приоритет.</p></li>
<li><p><code>ipc-thread-priority (Number = 100)</code></p>

<p>Приоритет IPC процесса. Чем меньше значение, тем выше приоритет.</p></li>
<li><p><code>worker-priority (Number = 4)</code></p>

<p>Приоритет рабочего процесса. Чем меньше значение, тем выше приоритет.</p></li>
<li><p><code>throw-exception-on-shutdown (boolean = false)</code></p>

<p>Выбрасывать исключение <code>Exception('event shutdown')</code> по завершению процесса.</p></li>
</ul>

<h4 id="zaprosyi">Запросы</h4>

<ul>
<li><p><code>locale (string = '')</code></p>

<p>Устанавливает настройки локали. Можно указать несколько через разделитель <code>","</code>.</p></li>
<li><p><code>ob-filter-auto (boolean = true)</code></p>

<p>Включить стандартный <code>ob_</code> фильтр.</p></li>
</ul>

<h4 id="rabochie-protsessyi">Рабочие процессы</h4>

<ul>
<li><p><code>chroot (string = '/')</code></p>

<p>Смена системного корня для рабочих процессов.</p></li>
<li><p><code>cwd (string = '.')</code></p>

<p>Задание рабочей директории для рабочих процессов.</p></li>
<li><p><code>user (string = null)</code></p>

<p>Пользователь для рабочих процессов. Используйте безопасного пользователя, не используйте root, если не знаете что делаете.</p></li>
<li><p><code>group (string = null)</code></p>

<p>Группа для рабочих процессов. Используйте безопасную группу, не используйте root, если не знаете что делаете.</p></li>
<li><p><code>auto-gc (Number = '1k')</code></p>

<p>Включает сборщик мусора вызываемый каждые n запросов. <code>0</code> – выключает совсем.</p></li>
</ul>

<h4 id="logirovanie-i-otladka">Логирование и отладка</h4>

<ul>
<li><p><code>logging (boolean = true)</code></p>

<p>Включает логирование.</p></li>
<li><p><code>log-storage (string = '/var/log/phpdaemon.log')</code></p>

<p>Путь к лог-файлу.</p></li>
<li><p><code>log-errors (boolean = true)</code></p>

<p>Включает логирование локальных ошибок таких как Undefined route in WebSocketServer, и т.д.</p></li>
<li><p><code>log-worker-set-state (boolean = false)</code></p>

<p>Включает логирование смены состояния рабочего процесса</p></li>
<li><p><code>log-events (boolean = false)</code></p>

<p>Включает логирование событий</p></li>
<li><p><code>log-signals (boolean = false)</code></p>

<p>Включает логирование SYSCTL сигналов.</p></li>
<li><p><code>verbose-tty (boolean = false)</code></p>

<p>Если true, STDIN, STDOUT и STDERR не будут закрыты.</p></li>
<li><p><code>restrict-error-control (boolean = false)</code></p>

<p>Выключает оператор управления ошибками <code>"@"</code>.</p></li>
</ul>

<h4 id="podsistema-vvoda-vyivoda-posix">Подсистема ввода-вывода POSIX</h4>

<ul>
<li><p><code>eio-enabled (boolean = true)</code></p>

<p>Включает поддержку EIO.</p></li>
<li><p><code>eio-set-max-idle (Time = null)</code></p>

<p>Устанавливает максимальное количество ожидающих потоков.</p></li>
<li><p><code>eio-set-min-parallel (Number = null)</code></p>

<p>Устанавливает минимальное количество параллельных потоков.</p></li>
<li><p><code>eio-set-max-parallel (Number = null)</code></p>

<p>Устанавливает максимальное количество параллельных потоков.</p></li>
<li><p><code>eio-set-max-poll-reqs (Number = null)</code></p>

<p>Устанавливает максимальное количество обрабатываемых запросов.</p></li>
<li><p><code>eio-set-max-poll-time (Time = null)</code></p>

<p>Устанавливает максимальное время выполнения.</p></li>
</ul>

<h3 id="prilozheniya">Приложения</h3>

<h2 id="razrabotka">Разработка</h2>

<h3 id="prilozhenie">Приложение</h3>

<h3 id="obrabotka-zaprosov">Обработка запросов</h3>

<h3 id="klientyi-i-serveryi">Клиенты и серверы</h3>

<h2 id="serveryi">Серверы</h2>

<h3 id="http">HTTP</h3>

<h3 id="fastcgi">FastCGI</h3>

<h3 id="debugconsole">DebugConsole</h3>

<h3 id="flashpolicy">FlashPolicy</h3>

<h3 id="ident">Ident</h3>

<h3 id="ircbouncer">IRCBouncer</h3>

<h3 id="lock">Lock</h3>

<h3 id="socks">Socks</h3>

<h3 id="websocket">WebSocket</h3>

<h2 id="klientyi">Клиенты</h2>

<h3 id="asterisk">Asterisk</h3>

<h3 id="dns">DNS</h3>

<h3 id="gibson">Gibson</h3>

<h3 id="http-2">HTTP</h3>

<h3 id="icmp">ICMP</h3>

<h3 id="irc">IRC</h3>

<h3 id="lock-2">Lock</h3>

<h3 id="memcache">Memcache</h3>

<h3 id="mongo">Mongo</h3>

<h3 id="mysql">MySQL</h3>

<h3 id="postgresql">PostgreSQL</h3>

<h3 id="redis">Redis</h3>

<h3 id="valve">Valve</h3>

<h3 id="websocket-2">WebSocket</h3>

<h3 id="xmpp">XMPP</h3>

<h2 id="biblioteki">Библиотеки</h2>

<h3 id="cache">Cache</h3>

<h3 id="complexjob">ComplexJob</h3>

<h3 id="shellcommand">ShellCommand</h3>

<h3 id="timer">Timer</h3>

<h3 id="transportcontext">TransportContext</h3>

<h3 id="dnode">DNode</h3>

<h3 id="fs">FS</h3>

<h3 id="pubsub">PubSub</h3>

<h2 id="utilityi">Утилиты</h2>

<h3 id="binary">Binary</h3>

<h3 id="crypt">Crypt</h3>

<h3 id="datetime">DateTime</h3>

<h3 id="encoding">Encoding</h3>

<h3 id="irc-2">IRC</h3>

<h3 id="mime">MIME</h3>

<h3 id="shmentity">ShmEntity</h3>

<h3 id="terminal">Terminal</h3>

<h2 id="strukturyi">Структуры</h2>

<h3 id="objectstorage">ObjectStorage</h3>

<h3 id="priorityqueuecallbacks">PriorityQueueCallbacks</h3>

<h3 id="stackcallbacks">StackCallbacks</h3>

<h2 id="traits">Traits</h2>

<h3 id="classwatchdog">ClassWatchdog</h3>

<h3 id="deferredeventhandlers">DeferredEventHandlers</h3>

<h3 id="eventhandlers">EventHandlers</h3>

<h3 id="sessions">Sessions</h3>

<h3 id="staticobjectwatchdog">StaticObjectWatchdog</h3>

<h3 id="strictstaticobjectwatchdog">StrictStaticObjectWatchdog</h3>

<h2 id="network">Network</h2>

<h3 id="client">Client</h3>

<h3 id="clientconnection">ClientConnection</h3>

<h3 id="connection">Connection</h3>

<h3 id="iostream">IOStream</h3>

<h3 id="pool">Pool</h3>

<h3 id="server">Server</h3>

<h2 id="faq">FAQ</h2>

<h2 id="publikatsii">Публикации</h2>

<h2 id="fyuchersyi">Фьючерсы</h2>

<h2 id="razrabotchiki">Разработчики</h2>

    </div>
</body>
</html>